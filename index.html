<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PRANNA  – App de Lealtad</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; background: #ffffff; min-height: 100vh; display: flex; flex-direction: column; }
header { background: #ffffff; color: #000000; text-align: center; padding: 28px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
header .logo svg { width: 200px; height: 100px; fill: currentColor; margin-bottom: 10px; }
main { flex: 1; padding: 22px; max-width: 420px; margin: auto; width: 100%; }
.card { background: #fff; border-radius: 14px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,.08); margin-bottom: 22px; }
input { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; margin-bottom: 14px; font-size: 1rem; }
input:focus { border-color: #ffffff; outline: none; }
button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 600; background: #ffffff; color: #000000; cursor: pointer; transition: background .3s; }
button:disabled { background: #bdc3c7; }
.center { text-align: center; }
.counter { font-size: 48px; font-weight: 700; color: #ffffff; margin: 18px 0; }
.reward { background: #f8f9fa; border-radius: 10px; padding: 14px; text-align: center; cursor: pointer; border: 2px solid transparent; margin-bottom: 12px; transition: border-color .3s; }
.reward:hover { border-color: #ffffff; }
.disabled { opacity: .5; cursor: not-allowed; }
nav { display: flex; gap: 8px; }
nav button { flex: 1; background: #fff; color: #333; border: 2px solid #e9ecef; }
nav button.active { background: #ffffff; color: #000000; }
.notification { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; }
.notification.unread { background: #fff3e0; border-left-color: #ff9800; font-weight: bold; }
.badge { background: #e74c3c; color: #fff; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; position: absolute; top: -8px; right: -8px; }
.hidden { display: none; }
</style>
</head>
<body>
<header>
<div class="logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3000 1000" width="3000" height="1000">
  <style>
    .wordmark {
      font-family: "Playfair Display", "Times New Roman", serif;
      font-size: 420px;
      font-weight: 400;
      fill: #000;
      letter-spacing: 25px;
    }
    .subtitle {
      font-family: "Helvetica Neue", Arial, sans-serif;
      font-size: 100px;
      font-weight: 700;
      fill: #000;
      letter-spacing: 8px;
    }
    .underline {
      stroke: #000;
      stroke-width: 5;
    }
  </style>

  <!-- Wordmark -->
  <text x="50%" y="420" text-anchor="middle" class="wordmark">PRANNA</text>

  <!-- Underline -->
  <line x1="600" y1="480" x2="2400" y2="480" class="underline" />

  <!-- Subtitle -->
  <text x="50%" y="640" text-anchor="middle" class="subtitle">
    BEAUTY STUDIO | CLOTHING BOUTIQUE
  </text>
</svg></div>
<h2>PRANNA </h2>
<p>Belleza a tu alcance </p>
</header>

<main id="login">
<div class="card">
<h3 class="center">Iniciar Sesión</h3>
<input id="phone" placeholder="Teléfono (10 dígitos)" maxlength="10" type="tel">
<input id="bdate" type="date">
<button onclick="login()">Ingresar</button>
</div>
</main>

<main id="app" class="hidden">
<div class="card center">
<h3 id="cname"></h3>
<div class="counter" id="cvis">0</div>
<p>visitas acumuladas</p>
</div>

<div id="rewardsSection">
<div class="card">
<h3>Recompensas</h3>
<div id="rewards"></div>
</div>
</div>

<div id="notificationsView" class="hidden">
<div class="card">
<h3>Notificaciones</h3>
<div id="notifications"></div>
</div>
</div>

<nav>
<button id="navRewards" class="active" onclick="showSection('rewards')">Recompensas</button>
<button id="navNotifications" style="position:relative" onclick="showSection('notifications')">
Notificaciones
<span id="navNotifBadge" class="badge hidden">0</span>
</button>
<button onclick="logout()">Salir</button>
</nav>
</main>

<script>
const API = 'https://script.google.com/macros/s/AKfycbwBLCfZTjB_Nu8HRnQABvjHALmwKl2LPVez9F6_931hrv-KZCrQ9fDo2zeecAS-oKhK/exec';
let user = null;
let notificationsList = [];

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(err => console.error('Service Worker registration failed:', err));
}

async function apiFetch(action, params = {}) {
  const url = new URL(API);
  url.searchParams.append('action', action);
  for (const key in params) {
    url.searchParams.append(key, params[key]);
  }
  
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Network response was not ok');
    return await response.json();
  } catch (error) {
    console.error('API Fetch Error:', error);
    alert('Error de conexión. Inténtalo de nuevo.');
    return { success: false, message: 'Error de conexión' };
  }
}

async function login() {
  const phone = document.getElementById('phone').value;
  const bdate = document.getElementById('bdate').value;
  
  if (phone.length !== 10 || !bdate) return alert('Datos incompletos');
  
  const result = await apiFetch('login', { phone, birthDate: bdate });
  
  if (!result.success) return alert(result.message);
  
  user = result.data;
  localStorage.setItem('user', JSON.stringify(user));
  init();
}

function init() {
  document.getElementById('login').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('cname').textContent = user.name;
  document.getElementById('cvis').textContent = user.visits;
  loadRewards();
  loadNotifications();
  setInterval(loadNotifications, 30000); // Refresh notifications every 30 seconds
}

async function loadRewards() {
  const result = await apiFetch('getRewards');
  if (!result.success) return;
  
  const container = document.getElementById('rewards');
  container.innerHTML = '';
  
  result.data.forEach(reward => {
    const canRedeem = user.visits >= reward.cost;
    const div = document.createElement('div');
    div.className = 'reward' + (canRedeem ? '' : ' disabled');
    div.innerHTML = `<strong>${reward.name}</strong><br>${reward.cost} visitas`;
    if (canRedeem) div.onclick = () => redeemReward(reward);
    container.appendChild(div);
  });
}

async function redeemReward(reward) {
  if (!confirm(`¿Canjear "${reward.name}" por ${reward.cost} visitas?`)) return;
  
  const result = await apiFetch('redeemReward', { folio: user.folio, rewardName: reward.name, rewardCost: reward.cost });
  
  if (!result.success) return alert(result.message);
  
  user.visits = result.data.visits;
  localStorage.setItem('user', JSON.stringify(user));
  document.getElementById('cvis').textContent = user.visits;
  loadRewards();
  alert('¡Recompensa canjeada!');
}

async function loadNotifications() {
  if (!user) return;
  const result = await apiFetch('getNotifications', { folio: user.folio });
  if (!result.success) return;

  notificationsList = result.data;
  displayNotifications();
  updateNotificationBadges();
}

function displayNotifications() {
  const container = document.getElementById('notifications');
  container.innerHTML = '';
  
  if (notificationsList.length === 0) {
    container.innerHTML = '<p class="center">No hay notificaciones</p>';
    return;
  }
  
  notificationsList.forEach(notif => {
    const div = document.createElement('div');
    div.className = 'notification' + (notif.read ? '' : ' unread');
    div.innerHTML = `<h4>${notif.title}</h4><p>${notif.message}</p><small>${new Date(notif.timestamp).toLocaleDateString()}</small>`;
    if (!notif.read) {
        div.onclick = () => markAsRead(notif.id);
    }
    container.appendChild(div);
  });
}

async function markAsRead(notificationId) {
  const notif = notificationsList.find(n => n.id === notificationId);
  if (notif && !notif.read) {
    notif.read = true;
    displayNotifications(); // Re-render to remove bold and onclick
    updateNotificationBadges();
    await apiFetch('markNotificationRead', { notificationId });
  }
}

function updateNotificationBadges() {
  const unreadCount = notificationsList.filter(n => !n.read).length;
  const badge = document.getElementById('navNotifBadge');
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

function showSection(section) {
  document.getElementById('navRewards').classList.toggle('active', section === 'rewards');
  document.getElementById('navNotifications').classList.toggle('active', section !== 'rewards');
  
  document.getElementById('rewardsSection').classList.toggle('hidden', section !== 'rewards');
  document.getElementById('notificationsView').classList.toggle('hidden', section === 'rewards');
}

function logout() {
  localStorage.removeItem('user');
  location.reload();
}

window.onload = () => {
  const storedUser = localStorage.getItem('user');
  if (storedUser) {
    user = JSON.parse(storedUser);
    init();
  }
};
</script>
</body>
</html>
